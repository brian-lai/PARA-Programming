#!/usr/bin/env bash
#
# para-init - Smart initialization for PARA-Programming
#
# Auto-detects installed AI coding tools and configures PARA-Programming
# without requiring users to understand "tiers" or implementation details.
#
# Usage:
#   para-init                    # Auto-detect and configure
#   para-init --tool=cursor      # Configure specific tool
#   para-init --tools=cursor,copilot  # Configure multiple specific tools
#   para-init --all              # Configure all detected tools
#   para-init --help             # Show help message

set -euo pipefail

# Script directory (for finding detect-tools.sh)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
if [[ -t 1 ]]; then
  BOLD='\033[1m'
  GREEN='\033[0;32m'
  BLUE='\033[0;34m'
  YELLOW='\033[1;33m'
  RED='\033[0;31m'
  RESET='\033[0m'
else
  BOLD=''
  GREEN=''
  BLUE=''
  YELLOW=''
  RED=''
  RESET=''
fi

# Configuration
VERBOSE=false
TOOL_OVERRIDE=""
SKIP_CLAUDE=false
CONFIGURE_ALL=false

# Help message
show_help() {
  cat <<EOF
${BOLD}para-init${RESET} - Smart initialization for PARA-Programming

${BOLD}USAGE:${RESET}
  para-init [OPTIONS]

${BOLD}OPTIONS:${RESET}
  --tool=<tool>         Configure only the specified tool
                        (claude, cursor, continue, copilot, gemini)

  --tools=<tool1,tool2> Configure multiple specific tools (comma-separated)

  --all                 Configure all detected tools without prompting

  --skip-claude         Skip Claude Code plugin installation message

  --verbose             Show detailed detection output

  --help                Show this help message

${BOLD}EXAMPLES:${RESET}
  para-init                      # Auto-detect and configure
  para-init --tool=cursor        # Configure only Cursor
  para-init --tools=cursor,copilot  # Configure Cursor and Copilot
  para-init --all                # Configure all detected tools

${BOLD}DESCRIPTION:${RESET}
  This script automatically detects which AI coding tools you have installed
  and configures PARA-Programming for them. No need to understand "tiers" or
  implementation details - just run the command and it works!

  Supported tools:
  • Claude Code (native plugin - installation instructions provided)
  • Cursor (full PARA support with slash commands)
  • Continue.dev (full PARA support with slash commands)
  • GitHub Copilot (methodology only, manual workflow)
  • Gemini (methodology only, manual workflow)

EOF
}

# Parse command-line arguments
parse_args() {
  for arg in "$@"; do
    case "$arg" in
      --help)
        show_help
        exit 0
        ;;
      --verbose)
        VERBOSE=true
        ;;
      --tool=*)
        TOOL_OVERRIDE="${arg#*=}"
        ;;
      --tools=*)
        TOOL_OVERRIDE="${arg#*=}"
        ;;
      --all)
        CONFIGURE_ALL=true
        ;;
      --skip-claude)
        SKIP_CLAUDE=true
        ;;
      *)
        echo -e "${RED}Error: Unknown option: $arg${RESET}" >&2
        echo "Run 'para-init --help' for usage information." >&2
        exit 1
        ;;
    esac
  done
}

# Detect installed tools
detect_tools() {
  if [[ "$VERBOSE" == "true" ]]; then
    "$SCRIPT_DIR/detect-tools.sh" --verbose
  else
    "$SCRIPT_DIR/detect-tools.sh"
  fi

  local status=$?
  if [[ $status -ne 0 ]]; then
    echo -e "${RED}✗ No AI coding tools detected.${RESET}"
    echo ""
    echo "Please install one of the supported tools:"
    echo "  • Claude Code: https://claude.ai/code"
    echo "  • Cursor: https://cursor.sh"
    echo "  • Continue.dev: https://continue.dev"
    echo "  • GitHub Copilot: https://github.com/features/copilot"
    echo "  • Gemini: https://ai.google.dev"
    exit 1
  fi
}

# Parse detection output
parse_detection_output() {
  local detection_output="$1"

  DETECTED_PLUGIN_TOOLS=()
  DETECTED_TIER1_TOOLS=()
  DETECTED_TIER2_TOOLS=()

  while IFS= read -r line; do
    case "$line" in
      PLUGIN:*)
        IFS=',' read -ra tools <<< "${line#PLUGIN:}"
        DETECTED_PLUGIN_TOOLS=("${tools[@]}")
        ;;
      FILE_BASED_TIER1:*)
        IFS=',' read -ra tools <<< "${line#FILE_BASED_TIER1:}"
        DETECTED_TIER1_TOOLS=("${tools[@]}")
        ;;
      FILE_BASED_TIER2:*)
        IFS=',' read -ra tools <<< "${line#FILE_BASED_TIER2:}"
        DETECTED_TIER2_TOOLS=("${tools[@]}")
        ;;
    esac
  done <<< "$detection_output"
}

# Display detected tools
display_detected_tools() {
  echo -e "${BOLD}Detecting AI coding tools...${RESET}"

  local all_tools=("${DETECTED_PLUGIN_TOOLS[@]}" "${DETECTED_TIER1_TOOLS[@]}" "${DETECTED_TIER2_TOOLS[@]}")

  for tool in "${all_tools[@]}"; do
    case "$tool" in
      claude)
        echo -e "${GREEN}✓${RESET} Found: Claude Code"
        ;;
      cursor)
        echo -e "${GREEN}✓${RESET} Found: Cursor"
        ;;
      continue)
        echo -e "${GREEN}✓${RESET} Found: Continue.dev"
        ;;
      copilot)
        echo -e "${GREEN}✓${RESET} Found: GitHub Copilot"
        ;;
      gemini)
        echo -e "${GREEN}✓${RESET} Found: Gemini"
        ;;
    esac
  done
  echo ""
}

# Show Claude Code plugin instructions
show_claude_instructions() {
  if [[ "$SKIP_CLAUDE" == "true" ]]; then
    return
  fi

  echo -e "${BOLD}Claude Code uses a native plugin for PARA-Programming.${RESET}"
  echo ""
  echo "Install the plugin:"
  echo -e "  ${BLUE}https://github.com/brian-lai/para-programming-plugin${RESET}"
  echo ""
  echo "Or use Claude Code's plugin manager:"
  echo -e "  ${BOLD}/install brian-lai/para-programming-plugin${RESET}"
  echo ""
  echo -e "${GREEN}✅ After installation, restart Claude Code and you're ready!${RESET}"
  echo ""
}

# Placeholder for setup logic (to be implemented in Phase 2)
setup_file_based_tools() {
  local tier1_tools=("$@")

  echo -e "${YELLOW}⚠️  Setup logic not yet implemented (Phase 2)${RESET}"
  echo ""
  echo "The following tools will be configured in Phase 2:"
  for tool in "${tier1_tools[@]}"; do
    echo "  • $tool"
  done
  echo ""
  echo -e "${BLUE}ℹ️  For now, refer to manual setup guides:${RESET}"
  echo "  • Cursor: cursor/README.md"
  echo "  • Continue.dev: continue/README.md"
  echo "  • GitHub Copilot: copilot/README.md"
  echo "  • Gemini: gemini/README.md"
}

# Main function
main() {
  parse_args "$@"

  echo -e "${BOLD}PARA-Programming Setup${RESET}"
  echo ""

  # Detect tools
  local detection_output
  detection_output=$(detect_tools)
  parse_detection_output "$detection_output"

  # Display detected tools
  display_detected_tools

  # Handle Claude Code if detected
  if [[ " ${DETECTED_PLUGIN_TOOLS[*]} " =~ " claude " ]]; then
    show_claude_instructions
  fi

  # Handle file-based tools
  local file_based_tools=("${DETECTED_TIER1_TOOLS[@]}" "${DETECTED_TIER2_TOOLS[@]}")

  if [[ ${#file_based_tools[@]} -gt 0 ]]; then
    setup_file_based_tools "${file_based_tools[@]}"
  fi

  # If only Claude Code was detected, we're done
  if [[ ${#file_based_tools[@]} -eq 0 && " ${DETECTED_PLUGIN_TOOLS[*]} " =~ " claude " ]]; then
    echo -e "${GREEN}Setup complete!${RESET}"
  fi
}

# Run main function
main "$@"
